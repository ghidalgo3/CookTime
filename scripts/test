#!/bin/bash
set -e

SCRIPT_DIR="$(dirname "$0")"
REPO_ROOT="$SCRIPT_DIR/.."

# --lint: run frontend linting only, then exit
if [ "$1" = "--lint" ]; then
    echo "Running frontend lint..."
    cd "$REPO_ROOT/src/CookTime/client-app"
    npx eslint src/
    echo "Lint passed!"
    exit 0
fi

API_URL="${API_BASE_URL:-http://localhost:5001}"
MAX_WAIT=30

echo "Waiting for API to be healthy at $API_URL/health..."
elapsed=0
until curl -sf "$API_URL/health" > /dev/null 2>&1; do
    if [ $elapsed -ge $MAX_WAIT ]; then
        echo "Error: API did not become healthy within ${MAX_WAIT}s"
        echo "Make sure to run 'scripts/server' first"
        echo ""
        echo "Docker logs for cooktime-api:"
        docker logs cooktime-api --tail 100
        exit 1
    fi
    sleep 2
    elapsed=$((elapsed + 2))
    echo "  ...waiting ($elapsed/${MAX_WAIT}s)"
done
echo "API is healthy!"

echo ""
echo "Running tests..."
cd "$REPO_ROOT/src/CookTimeTests"
dotnet build -v minimal
dotnet test --verbosity normal --no-build --logger "trx;LogFileName=test-results.trx" -- RunConfiguration.DisableParallelization=true
