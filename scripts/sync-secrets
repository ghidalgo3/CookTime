#!/bin/zsh

# Syncs secrets from Azure Key Vault "cooktime" to dotnet user-secrets
# Usage: ./scripts/sync-secrets

set -e

KEYVAULT_NAME="cooktime"
PROJECT_DIR="$(dirname "$0")/../src"

# Check if Azure CLI is installed
if ! command -v az &> /dev/null; then
    echo "Error: Azure CLI (az) is not installed"
    exit 1
fi

# Check if logged in to Azure
if ! az account show &> /dev/null; then
    echo "Error: Not logged in to Azure. Run 'az login' first."
    exit 1
fi

# Initialize user-secrets if not already done
echo "Initializing user-secrets for project..."
cd "$PROJECT_DIR"
dotnet user-secrets init 2>/dev/null || true

# Get list of secret names from Key Vault
echo "Fetching secrets from Key Vault '$KEYVAULT_NAME'..."
SECRET_NAMES=$(az keyvault secret list --vault-name "$KEYVAULT_NAME" --query "[].name" -o tsv)

if [ -z "$SECRET_NAMES" ]; then
    echo "No secrets found in Key Vault '$KEYVAULT_NAME'"
    exit 0
fi

# Iterate through each secret and set as user-secret
echo "Setting dotnet user-secrets..."
while IFS= read -r SECRET_NAME; do
    if [ -n "$SECRET_NAME" ]; then
        # Get the secret value
        SECRET_VALUE=$(az keyvault secret show --vault-name "$KEYVAULT_NAME" --name "$SECRET_NAME" --query "value" -o tsv)
        
        # Convert Key Vault naming convention (dashes) to dotnet config convention (colons)
        # e.g., "ConnectionStrings--DefaultConnection" becomes "ConnectionStrings:DefaultConnection"
        DOTNET_KEY=$(echo "$SECRET_NAME" | sed 's/--/:/g')
        
        # Set the user secret
        dotnet user-secrets set "$DOTNET_KEY" "$SECRET_VALUE"
        echo "  âœ“ $DOTNET_KEY"
    fi
done <<< "$SECRET_NAMES"

echo ""
echo "Done! Secrets synced from Key Vault to user-secrets."
echo "View secrets with: dotnet user-secrets list"
